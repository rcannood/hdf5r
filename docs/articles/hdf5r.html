<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to the hdf5r package • hdf5r</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to the hdf5r package">
<meta property="og:description" content="hdf5r">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hdf5r</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.3.9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/hdf5r.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hhoeflin/hdf5r/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to the hdf5r package</h1>
                        <h4 data-toc-skip class="author">Holger
Hoefling</h4>
            
            <h4 data-toc-skip class="date">April 17th 2016</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hhoeflin/hdf5r/blob/HEAD/vignettes/hdf5r.Rmd" class="external-link"><code>vignettes/hdf5r.Rmd</code></a></small>
      <div class="hidden name"><code>hdf5r.Rmd</code></div>

    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      <p>Overview on how to use the simple as well as advanced
      facilities of HDF5 using the <strong>hdf5r</strong> package</p>
    </div>
    
<hr>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<blockquote>
<p>HDF5 is a data model, library, and file format for storing and
managing data. It supports an unlimited variety of datatypes, and is
designed for flexible and efficient I/O and for high volume and complex
data.</p>
</blockquote>
<p>As R is very often used to process large amounts of data, having a
direct interface to HDF5 is very useful. As of the writing of this
vignette, there are 2 other packages available that also implement an
interface to HDF5, <strong>h5</strong> on CRAN and
<strong>rhdf5</strong> on Bioconductor. These are also good
implementations, but there are several points that make this package
here – <strong>hdf5r</strong> – stand out:</p>
<ul>
<li>User friendly interface that allows access to datasets in the same
fashion a user would access regular R arrays</li>
<li>All HDF5 classes are implemented using R6 classes, allowing for a
very simple way of manipulating objects</li>
<li>The library is almost feature complete, implementing most of the
functionality of the HDF5 C-API. Some exceptions are for example
functions that expect other C-functions as arguments.</li>
<li>It ships with the newest version 1.10.0 of HDF5</li>
<li>All HDF5 constants and datatypes are available under their regular
name.</li>
<li>All HDF5 functions that return constants do this in the format of an
<em>extended-factor-variable</em>, giving the constants value as well as
the name. Furthermore, all functions that in HDF5 return
<em>C-structs</em>, return a data frame with the same variable names as
in the structs (usually used by the various “-info” functions).</li>
<li>Tracking and closing of unused HDF5 resources is done completely
automatically using the R garbage collector.</li>
</ul>
<p>In the following sections of this vignette, first a simple example
will be given that shows how standard operations are being performed.
Next, more advanced features will be discussed such as the creation of
complex datatypes, datasets with special datatypes, the setting of the
various available filters when reading/writing a package etc. We will
end with a technical overview on the underlying implementation.</p>
<hr>
</div>
<div class="section level2">
<h2 id="a-simple-example">A simple example<a class="anchor" aria-label="anchor" href="#a-simple-example"></a>
</h2>
<p>As an introduction on how to use it, let us set up a very simple
usage example. We will create a file, some groups in it as well as
datasets of different sizes. We will read and write data, delete
datasets again, get information on various objects.</p>
<div class="section level3">
<h3 id="creating-files-groups-and-datasets">Creating files, groups and datasets<a class="anchor" aria-label="anchor" href="#creating-files-groups-and-datasets"></a>
</h3>
<p>But first things first. We create a random filename in a temporary
directory and create a file with read/write access, deleting it if it
already exists (it won’t - tempfile gives us a name of a file that
doesn’t exist yet).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hhoeflin.github.io/hdf5r/" class="external-link">hdf5r</a></span><span class="op">)</span></span>
<span><span class="va">test_filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".h5"</span><span class="op">)</span></span>
<span><span class="va">file.h5</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5File-class.html">H5File</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">test_filename</span>, mode <span class="op">=</span> <span class="st">"w"</span><span class="op">)</span></span>
<span><span class="va">file.h5</span></span></code></pre></div>
<pre><code><span><span class="co">## Class: H5File</span></span>
<span><span class="co">## Filename: /tmp/RtmpCMEH18/file1226d3b980741.h5</span></span>
<span><span class="co">## Access type: H5F_ACC_RDWR</span></span></code></pre>
<p>Now that we have this, we will create 2 groups, one for the
<strong>mtcars</strong> dataset and one for the
<strong>nycflights13</strong> dataset.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars.grp</span> <span class="op">&lt;-</span> <span class="va">file.h5</span><span class="op">$</span><span class="fu">create_group</span><span class="op">(</span><span class="st">"mtcars"</span><span class="op">)</span></span>
<span><span class="va">flights.grp</span> <span class="op">&lt;-</span> <span class="va">file.h5</span><span class="op">$</span><span class="fu">create_group</span><span class="op">(</span><span class="st">"flights"</span><span class="op">)</span></span></code></pre></div>
<p>Into these groups, we will now write the datasets</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">datasets</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13" class="external-link">nycflights13</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape" class="external-link">reshape2</a></span><span class="op">)</span></span>
<span><span class="va">mtcars.grp</span><span class="op">[[</span><span class="st">"mtcars"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/mtcars.html" class="external-link">mtcars</a></span></span>
<span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"weather"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">nycflights13</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/nycflights13/man/weather.html" class="external-link">weather</a></span></span>
<span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"flights"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">nycflights13</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/nycflights13/man/flights.html" class="external-link">flights</a></span></span></code></pre></div>
<p>Out of the weather data, we extract the information on the
wind-direction and wind-speed and will save it as a matrix with the
hours in the columns and the days in the rows (only for weather station
<em>EWR</em>, the others are not complete).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weather_wind_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="fu">nycflights13</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/nycflights13/man/weather.html" class="external-link">weather</a></span>, <span class="va">origin</span> <span class="op">==</span> <span class="st">"EWR"</span>, select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>,</span>
<span>    <span class="st">"month"</span>, <span class="st">"day"</span>, <span class="st">"hour"</span>, <span class="st">"wind_dir"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">weather_wind_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.exclude</a></span><span class="op">(</span><span class="va">weather_wind_dir</span><span class="op">)</span></span>
<span><span class="va">weather_wind_dir</span><span class="op">$</span><span class="va">wind_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">weather_wind_dir</span><span class="op">$</span><span class="va">wind_dir</span><span class="op">)</span></span>
<span><span class="va">weather_wind_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html" class="external-link">acast</a></span><span class="op">(</span><span class="va">weather_wind_dir</span>, <span class="va">year</span> <span class="op">+</span> <span class="va">month</span> <span class="op">+</span> <span class="va">day</span> <span class="op">~</span> <span class="va">hour</span>, value.var <span class="op">=</span> <span class="st">"wind_dir"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Aggregation function missing: defaulting to length</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"wind_dir"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">weather_wind_dir</span></span></code></pre></div>
<p>and</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weather_wind_speed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="fu">nycflights13</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/nycflights13/man/weather.html" class="external-link">weather</a></span>, <span class="va">origin</span> <span class="op">==</span> <span class="st">"EWR"</span>, select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>,</span>
<span>    <span class="st">"month"</span>, <span class="st">"day"</span>, <span class="st">"hour"</span>, <span class="st">"wind_speed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">weather_wind_speed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.exclude</a></span><span class="op">(</span><span class="va">weather_wind_speed</span><span class="op">)</span></span>
<span><span class="va">weather_wind_speed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html" class="external-link">acast</a></span><span class="op">(</span><span class="va">weather_wind_speed</span>, <span class="va">year</span> <span class="op">+</span> <span class="va">month</span> <span class="op">+</span> <span class="va">day</span> <span class="op">~</span> <span class="va">hour</span>, value.var <span class="op">=</span> <span class="st">"wind_speed"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Aggregation function missing: defaulting to length</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"wind_speed"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">weather_wind_speed</span></span></code></pre></div>
<p>For completeness, we also attach the row and column names as
attributes:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/h5attributes.html">h5attr</a></span><span class="op">(</span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"wind_dir"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"colnames"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">weather_wind_dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/h5attributes.html">h5attr</a></span><span class="op">(</span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"wind_dir"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"rownames"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">weather_wind_dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/h5attributes.html">h5attr</a></span><span class="op">(</span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"wind_speed"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"colnames"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">weather_wind_speed</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/h5attributes.html">h5attr</a></span><span class="op">(</span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"wind_speed"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"rownames"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">weather_wind_speed</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="getting-information-about-different-objects">Getting information about different objects<a class="anchor" aria-label="anchor" href="#getting-information-about-different-objects"></a>
</h3>
<div class="section level4">
<h4 id="content-of-files-and-groups">Content of files and groups<a class="anchor" aria-label="anchor" href="#content-of-files-and-groups"></a>
</h4>
<p>With respect to groups and files, we also want to have a simple way
to extract the contents. With the <strong>names</strong> function, we
can get all names of objects in a group or in the root directory of a
file</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">file.h5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "flights" "mtcars"</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">flights.grp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "flights"    "weather"    "wind_dir"   "wind_speed"</span></span></code></pre>
<p>Another option that gives more information is <strong>ls</strong>, a
method of the classes <strong>H5File</strong> and
<strong>H5Group</strong></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights.grp</span><span class="op">$</span><span class="fu">ls</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         name     link.type    obj_type num_attrs group.nlinks group.mounted</span></span>
<span><span class="co">## 1    flights H5L_TYPE_HARD H5I_DATASET         0           NA            NA</span></span>
<span><span class="co">## 2    weather H5L_TYPE_HARD H5I_DATASET         0           NA            NA</span></span>
<span><span class="co">## 3   wind_dir H5L_TYPE_HARD H5I_DATASET         2           NA            NA</span></span>
<span><span class="co">## 4 wind_speed H5L_TYPE_HARD H5I_DATASET         2           NA            NA</span></span>
<span><span class="co">##   dataset.rank dataset.dims dataset.maxdims dataset.type_class</span></span>
<span><span class="co">## 1            1       336776             Inf       H5T_COMPOUND</span></span>
<span><span class="co">## 2            1        26115             Inf       H5T_COMPOUND</span></span>
<span><span class="co">## 3            2     364 x 24       Inf x Inf        H5T_INTEGER</span></span>
<span><span class="co">## 4            2     364 x 24       Inf x Inf        H5T_INTEGER</span></span>
<span><span class="co">##   dataset.space_class committed_type</span></span>
<span><span class="co">## 1          H5S_SIMPLE           &lt;NA&gt;</span></span>
<span><span class="co">## 2          H5S_SIMPLE           &lt;NA&gt;</span></span>
<span><span class="co">## 3          H5S_SIMPLE           &lt;NA&gt;</span></span>
<span><span class="co">## 4          H5S_SIMPLE           &lt;NA&gt;</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="information-on-attributes-datatypes-and-datasets">Information on attributes, datatypes and datasets<a class="anchor" aria-label="anchor" href="#information-on-attributes-datatypes-and-datasets"></a>
</h4>
<p>If you have an HDF5-File, it is of course important to look up
various information not only about groups, but also about the
information contained in it. First, we want to get more information
about the dataset. <strong>ls</strong> on the group already gives a lot
of information about the datatype, the size, the maximum size etc.
However there are also other, more direct, ways to get the same
information. In order to investigate the datatype we can</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weather_ds</span> <span class="op">&lt;-</span> <span class="va">flights.grp</span><span class="op">[[</span><span class="st">"weather"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">weather_ds_type</span> <span class="op">&lt;-</span> <span class="va">weather_ds</span><span class="op">$</span><span class="fu">get_type</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">weather_ds_type</span><span class="op">$</span><span class="fu">get_class</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] H5T_COMPOUND</span></span>
<span><span class="co">## 13 Levels: H5T_NO_CLASS H5T_INTEGER H5T_FLOAT H5T_TIME ... H5T_NCLASSES</span></span>
<span><span class="co">## 13 Values: -1 0 1 2 ... 11</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">weather_ds_type</span><span class="op">$</span><span class="fu">to_text</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## H5T_COMPOUND {</span></span>
<span><span class="co">##       H5T_STRING {</span></span>
<span><span class="co">##          STRSIZE H5T_VARIABLE;</span></span>
<span><span class="co">##          STRPAD H5T_STR_NULLTERM;</span></span>
<span><span class="co">##          CSET H5T_CSET_ASCII;</span></span>
<span><span class="co">##          CTYPE H5T_C_S1;</span></span>
<span><span class="co">##       } "origin" : 0;</span></span>
<span><span class="co">##       H5T_STD_I32LE "year" : 8;</span></span>
<span><span class="co">##       H5T_STD_I32LE "month" : 12;</span></span>
<span><span class="co">##       H5T_STD_I32LE "day" : 16;</span></span>
<span><span class="co">##       H5T_STD_I32LE "hour" : 20;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "temp" : 24;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "dewp" : 32;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "humid" : 40;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "wind_dir" : 48;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "wind_speed" : 56;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "wind_gust" : 64;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "precip" : 72;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "pressure" : 80;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "visib" : 88;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "time_hour" : 96;</span></span>
<span><span class="co">##    }</span></span></code></pre>
<p>telling us that our dataset consists of a <em>H5T_COMPOUND</em>
datatype and prints more detailed information on its content of every
column. Regarding the size of the dataset and the size of the chunks
(datasets are by default chunked; more about this below) we do:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weather_ds</span><span class="op">$</span><span class="va">dims</span></span>
<span><span class="va">weather_ds</span><span class="op">$</span><span class="va">maxdims</span></span>
<span><span class="va">weather_ds</span><span class="op">$</span><span class="va">chunk_dims</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 26115</span></span>
<span><span class="co">## [1] Inf</span></span>
<span><span class="co">## [1] 78</span></span></code></pre>
<p>In order to get information on attributes we also have various
function available. Which attributes are attached to an object we can
see with</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/h5attributes.html">h5attr_names</a></span><span class="op">(</span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"wind_dir"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "colnames" "rownames"</span></span></code></pre>
<p>and the content of one attribute can be extracted with
<strong>h5attr</strong>, the content of all of them with a list as
<strong>h5attributes</strong>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/h5attributes.html">h5attr</a></span><span class="op">(</span><span class="va">flights.grp</span><span class="op">[[</span><span class="st">"wind_dir"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"colnames"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "0"  "1"  "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10" "11" "12" "13" "14"</span></span>
<span><span class="co">## [16] "15" "16" "17" "18" "19" "20" "21" "22" "23"</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="detailed-information-about-various-objects">Detailed information about various objects<a class="anchor" aria-label="anchor" href="#detailed-information-about-various-objects"></a>
</h4>
<p>In HDF5, there are also various ways of getting more detailed
information about objects. The most detailed methods for this are</p>
<ul>
<li>
<strong>get_obj_info:</strong> Various information on the number of
attributes, the type of the object, the reference count, access times
(if set to be recorded) and other more technical information</li>
<li>
<strong>get_link_info:</strong> For links, mainly yields information
on the link type, i.e. hard link or soft link. The difference between
them and how to create them will be discussed further below.</li>
<li>
<strong>get_group_info:</strong> Information about the storage type
of the group, if a file is mounted to the group and the number of items
in the group. For the casual user, the most interesting information is
the number of items in the group, which can also be retrieved using the
<strong>names</strong> function. For very large groups, this way is
however more efficient.</li>
<li>
<strong>get_file_name:</strong> For an <em>H5File</em> or
<em>H5Group</em>, <em>H5D</em> or <em>H5T</em> (where D is for dataset
and T stands for a committed type) object, returns the name of the file
it is in.</li>
<li>
<strong>get_obj_name:</strong> Similar as <em>get_file_name</em>,
applies to the same object, but returns the path <strong>inside</strong>
the file to the object</li>
<li>
<strong>file_info:</strong> It extracts relatively technical
information about a file. It can only be applied to an object of class
<strong>H5File</strong>. This function is usually not of interest to the
casual user</li>
</ul>
<p>Most of these are somewhat advanced. They key information can usually
also be extracted with one of the “higher-level” methods shown above,
but sometimes the <em>info</em> methods are more efficient.</p>
</div>
</div>
<div class="section level3">
<h3 id="assigning-data-into-datasets-and-deleting-datasets">Assigning data into datasets and deleting datasets<a class="anchor" aria-label="anchor" href="#assigning-data-into-datasets-and-deleting-datasets"></a>
</h3>
<p>Of course we also want to to be able to read out data, change it,
extend the dataset and also delete it again. Reading out the data works
just as it does for regular R arrays and data frames. However,
HDF5-tables only have one dimension, not two. It is currently not
possible to selectively read columns - all of them have to be read at
the same time. For arrays, any data point can be read on its without
restrictions</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weather_ds</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   origin year month day hour  temp  dewp humid wind_dir wind_speed wind_gust</span></span>
<span><span class="co">## 1    EWR 2013     1   1    1 39.02 26.06 59.37      270   10.35702        NA</span></span>
<span><span class="co">## 2    EWR 2013     1   1    2 39.02 26.96 61.63      250    8.05546        NA</span></span>
<span><span class="co">## 3    EWR 2013     1   1    3 39.02 28.04 64.43      240   11.50780        NA</span></span>
<span><span class="co">## 4    EWR 2013     1   1    4 39.92 28.04 62.21      250   12.65858        NA</span></span>
<span><span class="co">## 5    EWR 2013     1   1    5 39.02 28.04 64.43      260   12.65858        NA</span></span>
<span><span class="co">##   precip pressure visib  time_hour</span></span>
<span><span class="co">## 1      0   1012.0    10 1357020000</span></span>
<span><span class="co">## 2      0   1012.3    10 1357023600</span></span>
<span><span class="co">## 3      0   1012.5    10 1357027200</span></span>
<span><span class="co">## 4      0   1012.2    10 1357030800</span></span>
<span><span class="co">## 5      0   1011.9    10 1357034400</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wind_dir_ds</span> <span class="op">&lt;-</span> <span class="va">flights.grp</span><span class="op">[[</span><span class="st">"wind_dir"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">wind_dir_ds</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">## [1,]    0    1    1    1    1    1    1    1    1     1     1     1     0     1</span></span>
<span><span class="co">## [2,]    1    1    1    1    1    1    1    1    1     1     1     1     1     1</span></span>
<span><span class="co">## [3,]    1    1    1    1    1    1    1    1    1     1     1     0     1     1</span></span>
<span><span class="co">##      [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24]</span></span>
<span><span class="co">## [1,]     1     1     1     1     1     1     1     1     1     1</span></span>
<span><span class="co">## [2,]     1     1     1     1     1     1     1     1     1     1</span></span>
<span><span class="co">## [3,]     1     1     1     1     1     1     1     1     1     1</span></span></code></pre>
<p>Let us replace one row. Currently, vector-recycling is not enabled,
so you have to ensure that your replacements have the correct size.
Recycling may be enabled in the future.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wind_dir_ds</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">24</span><span class="op">)</span></span>
<span><span class="va">wind_dir_ds</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</span></span></code></pre>
<p>It is also possible to add data outside the dimensions of the dataset
as long as they are within the <em>maxdims</em>. The dataset will be
expanded to accommodate the new data. When the expansion of the dataset
leads to unassigned points, they are filled with the default fill value.
The default fill value can be obtained using</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wind_dir_ds</span><span class="op">$</span><span class="fu">get_fill_value</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wind_dir_ds</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">25</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">wind_dir_ds</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">## [1,]    1    1    1    1    1    1    1    1    1     1     1     1     1     1</span></span>
<span><span class="co">## [2,]    1    1    1    1    1    1    1    1    1     1     1     1     1     1</span></span>
<span><span class="co">##      [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24] [,25]</span></span>
<span><span class="co">## [1,]     1     1     1     1     1     1     1     1     1     1     1</span></span>
<span><span class="co">## [2,]     1     1     1     1     1     1     1     1     1     1     0</span></span></code></pre>
<p>Now that we have expanded the dataset to have a 25th column, filled
with 0s except for the first column, it only remains to show how to
delete a dataset. However note: Deleting a dataset does not lead to a
reduction in HDF5 file size, but the internal space can be re-used for
other datasets later.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights.grp</span><span class="op">$</span><span class="fu">link_delete</span><span class="op">(</span><span class="st">"wind_dir"</span><span class="op">)</span></span>
<span><span class="va">flights.grp</span><span class="op">$</span><span class="fu">ls</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         name     link.type    obj_type num_attrs group.nlinks group.mounted</span></span>
<span><span class="co">## 1    flights H5L_TYPE_HARD H5I_DATASET         0           NA            NA</span></span>
<span><span class="co">## 2    weather H5L_TYPE_HARD H5I_DATASET         0           NA            NA</span></span>
<span><span class="co">## 3 wind_speed H5L_TYPE_HARD H5I_DATASET         2           NA            NA</span></span>
<span><span class="co">##   dataset.rank dataset.dims dataset.maxdims dataset.type_class</span></span>
<span><span class="co">## 1            1       336776             Inf       H5T_COMPOUND</span></span>
<span><span class="co">## 2            1        26115             Inf       H5T_COMPOUND</span></span>
<span><span class="co">## 3            2     364 x 24       Inf x Inf        H5T_INTEGER</span></span>
<span><span class="co">##   dataset.space_class committed_type</span></span>
<span><span class="co">## 1          H5S_SIMPLE           &lt;NA&gt;</span></span>
<span><span class="co">## 2          H5S_SIMPLE           &lt;NA&gt;</span></span>
<span><span class="co">## 3          H5S_SIMPLE           &lt;NA&gt;</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="closing-the-file">Closing the file<a class="anchor" aria-label="anchor" href="#closing-the-file"></a>
</h3>
<p>As a last step, we want to close the file. For this, we have 2
options, the <strong>close</strong> and <strong>close_all</strong>
methods of an h5-file. There are some non-obvious differences for novice
users between the two. <strong>close</strong> will close the file, but
groups and datatsets that are already open, will stay open. Furthermore,
as along as any object is still open, the file cannot be re-opened in
the regular fashion as HDF5 prevents a file from being opened more than
once.</p>
<p>However, it can be quite cumbersome to close all objects associated
with a file - that is if we even have still access to them. We may have
created an object, discarded it, but the garbage collector hasn’t closed
it yet.</p>
<p>In order to make this process simpler for the end-user,
<strong>close_all</strong> closes the file as well as all objects
associated with the file. Any R6-classes pointing to the object will
automatically be invalidated. This way, if it is needed, the file can be
re-opened again.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.h5</span><span class="op">$</span><span class="fu">close_all</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>As a rule - it is recommended to work in the following fashion. Open
a file with <strong>H5File$new</strong> and store the resulting R6-class
object. Do not discard this object. The current default behavior is to
close the file, but not the objects inside the file if the garbage
collector is triggered. This is done in order not to interfere with
other open objects later, but as explained can prevent the the
re-opening of the file later. Therefore, do not discard the R6-class
pointing to a file - and close it later again using the **close_all*
method in order to ensure that all IDs using the file are being closed
as well.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="advanced-features">Advanced features<a class="anchor" aria-label="anchor" href="#advanced-features"></a>
</h2>
<p>HDF5 provides a very wide range of tools. Describing it here would
certainly be a task that is too large for this vignette. For a complete
overview on what HDF5 can do, the reader should have a look at the <a href="https://www.hdfgroup.org/solutions/hdf5/" class="external-link">HDF5 website</a> and the
documentation that is listed there as well as specifically the <a href="https://docs.hdfgroup.org/hdf5/develop/_r_m.html" class="external-link">reference
manual</a>. Most API-functions that are referenced there are already
implemented (and any other missing functionality that is feasible will
hopefully follow soon).</p>
<p>In this section we will will therefore only shine a spotlight on a
number of low-level API functions that can be used in connection with
creating datasets as well as datatypes.</p>
<div class="section level3">
<h3 id="creating-datasets">Creating datasets<a class="anchor" aria-label="anchor" href="#creating-datasets"></a>
</h3>
<p>As we have already seen above, a dataset can be created by simply
assigning an appropriate R object under a given name into a group or a
file. The automatic algorithm then uses the size of the assigned object
to determine the size of the HDF5 dataset, it makes assumptions about
“chunking” that have an influence on the storage efficiency as well as
the maximum possible size of the dataset.</p>
<p>However, we have much more control if we specify these things “by
hand”. In the following example, we will create a dataset consisting of
2 bit unsigned integers (i.e. capable of storing values from 0 to 3). We
will set the size of the dataset as well as the space and the chunk-size
ourselves. As a first step, lets create the custom datatype</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">uint2_dt</span> <span class="op">&lt;-</span> <span class="va">h5types</span><span class="op">$</span><span class="va">H5T_NATIVE_UINT32</span><span class="op">$</span><span class="fu">set_size</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">set_precision</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="fu">set_sign</span><span class="op">(</span><span class="va">h5const</span><span class="op">$</span><span class="va">H5T_SGN_NONE</span><span class="op">)</span></span></code></pre></div>
<p>Here we use a built-in constant and datatype. All constants can be
accessed using <strong>h5const<span class="math inline">\(&lt;const_name&gt;** and all built-in types are
accesses with **h5types\)</span><type_name></type_name></strong>. An overview of all
existing constants can be retrieved with <strong>h5const<span class="math inline">\(overview** and all existing types are shown by
**h5types\)</span>overview</strong>.</p>
<p>Next we define the space that we will use for the dataset, where we
want 10 columns and 10 rows. The number of columns will always be fixed,
but the number of rows should be able to increase to infinity.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">space_ds</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5S-class.html">H5S</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, maxdims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">Inf</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next, we have to define with which properties the dataset should be
created. We will set a default fill value of 1, enable n-bit filtering
but no compression and set the chunk size to (10, 10).</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds_create_pl_nbit</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5P_DATASET_CREATE-class.html">H5P_DATASET_CREATE</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ds_create_pl_nbit</span><span class="op">$</span><span class="fu">set_chunk</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="fu">set_fill_value</span><span class="op">(</span><span class="va">uint2_dt</span>, <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">set_nbit</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Now lets put all this together and create a dataset.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">uint2.grp</span> <span class="op">&lt;-</span> <span class="va">file.h5</span><span class="op">$</span><span class="fu">create_group</span><span class="op">(</span><span class="st">"uint2"</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_nbit</span> <span class="op">&lt;-</span> <span class="va">uint2.grp</span><span class="op">$</span><span class="fu">create_dataset</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"nbit_filter"</span>, space <span class="op">=</span> <span class="va">space_ds</span>,</span>
<span>    dtype <span class="op">=</span> <span class="va">uint2_dt</span>, dataset_create_pl <span class="op">=</span> <span class="va">ds_create_pl_nbit</span>, chunk_dim <span class="op">=</span> <span class="cn">NULL</span>, gzip_level <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_nbit</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">3</span>, size <span class="op">=</span> <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_nbit</span><span class="op">$</span><span class="fu">get_storage_size</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 26</span></span></code></pre>
<p>And not lets compare what happens if we don’t have any filter, only
compression and nbit as well as compression</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds_create_pl_nbit_deflate</span> <span class="op">&lt;-</span> <span class="va">ds_create_pl_nbit</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">set_deflate</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span></span>
<span><span class="va">ds_create_pl_deflate</span> <span class="op">&lt;-</span> <span class="va">ds_create_pl_nbit</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">remove_filter</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">set_deflate</span><span class="op">(</span><span class="fl">9</span><span class="op">)</span></span>
<span><span class="va">ds_create_pl_none</span> <span class="op">&lt;-</span> <span class="va">ds_create_pl_nbit</span><span class="op">$</span><span class="fu">copy</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">remove_filter</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_nbit_deflate</span> <span class="op">&lt;-</span> <span class="va">uint2.grp</span><span class="op">$</span><span class="fu">create_dataset</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"nbit_deflate_filter"</span>, space <span class="op">=</span> <span class="va">space_ds</span>,</span>
<span>    dtype <span class="op">=</span> <span class="va">uint2_dt</span>, dataset_create_pl <span class="op">=</span> <span class="va">ds_create_pl_nbit_deflate</span>, chunk_dim <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    gzip_level <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_nbit_deflate</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">uint2_ds_nbit</span><span class="op">[</span>, <span class="op">]</span></span>
<span><span class="va">uint2_ds_deflate</span> <span class="op">&lt;-</span> <span class="va">uint2.grp</span><span class="op">$</span><span class="fu">create_dataset</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"deflate_filter"</span>, space <span class="op">=</span> <span class="va">space_ds</span>,</span>
<span>    dtype <span class="op">=</span> <span class="va">uint2_dt</span>, dataset_create_pl <span class="op">=</span> <span class="va">ds_create_pl_deflate</span>, chunk_dim <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    gzip_level <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_deflate</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">uint2_ds_nbit</span><span class="op">[</span>, <span class="op">]</span></span>
<span><span class="va">uint2_ds_none</span> <span class="op">&lt;-</span> <span class="va">uint2.grp</span><span class="op">$</span><span class="fu">create_dataset</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"none_filter"</span>, space <span class="op">=</span> <span class="va">space_ds</span>,</span>
<span>    dtype <span class="op">=</span> <span class="va">uint2_dt</span>, dataset_create_pl <span class="op">=</span> <span class="va">ds_create_pl_none</span>, chunk_dim <span class="op">=</span> <span class="cn">NULL</span>, gzip_level <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_none</span><span class="op">[</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">uint2_ds_nbit</span><span class="op">[</span>, <span class="op">]</span></span></code></pre></div>
<p>With the sizes of the datasets</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">uint2_ds_nbit_deflate</span><span class="op">$</span><span class="fu">get_storage_size</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_nbit</span><span class="op">$</span><span class="fu">get_storage_size</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_deflate</span><span class="op">$</span><span class="fu">get_storage_size</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">uint2_ds_none</span><span class="op">$</span><span class="fu">get_storage_size</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 35</span></span>
<span><span class="co">## [1] 26</span></span>
<span><span class="co">## [1] 56</span></span>
<span><span class="co">## [1] 100</span></span></code></pre>
<p>and we see that in the case of random data, not surprisingly, the
nbit filter alone is the most efficient. Using compression on the
nbit-filter actually increases the storage size. However, despite the
random data, compression can still save some space compared to raw
storage as in raw storage mode, a whole byte is stored and not just 2
bit.</p>
</div>
<div class="section level3">
<h3 id="interacting-with-datatypes">Interacting with datatypes<a class="anchor" aria-label="anchor" href="#interacting-with-datatypes"></a>
</h3>
<div class="section level4">
<h4 id="integer-float">Integer, Float<a class="anchor" aria-label="anchor" href="#integer-float"></a>
</h4>
<p>For integer-datatypes we have already seen that we have control over
essentially everything, i.e. signed/unsigned as well as precision down
to the exact number of bits. For floats we have similar control, being
able to customize the size of the mantissa as well as the exponent
(although in practice this is likely less relevant than being able to
customize integer types). To learn more about this functionality for
floats, we recommend to read the relevant section of the manual.</p>
</div>
<div class="section level4">
<h4 id="strings">Strings<a class="anchor" aria-label="anchor" href="#strings"></a>
</h4>
<p>HDF5 itself provides access to both C-type strings and FORTRAN type
strings. As R internally uses C-strings, only C-type strings are
supported (i.e. strings that are NULL delimited). In terms of the size
of the strings, there are fixed and variable length strings
available.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">str_fixed_len</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5T_STRING-class.html">H5T_STRING</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">str_var_length</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5T_STRING-class.html">H5T_STRING</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>size <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
<p>These two types of strings have implications for efficiency and
usability. For obvious reasons, variable length strings are more
convenient as they are never too small hold a piece of information.
However, internally in HDF5, these aren’t stored in the dataset itself -
only a pointer to the HDF5-internal heap is stored. This has 2
implications:</p>
<ul>
<li>Retrieving the string is somewhat slower</li>
<li>As the heap is not compressed, compression of datasets does not
yield much space saving for variable length data</li>
</ul>
<p>From this perspective, fixed length strings are considerably better
as they are both faster (if not too long) and compressible. However, the
user has to be careful that their strings aren’t getting too long, or
they will be truncated.</p>
</div>
<div class="section level4">
<h4 id="enum">Enum<a class="anchor" aria-label="anchor" href="#enum"></a>
</h4>
<p>The equivalent to factors in R are <strong>ENUM</strong> datatypes.
These are stored internally as integers, but each integer has a string
label attached to it. In contrast to R-factor variables, the integer
values do not have to start at 1 and do not have to to consecutive
either. In order to support this more flexible datatype also optimally
on the R side, hdf5r comes with the <strong>factor_extended</strong>
class. In the HDF5 API - each enum level is inserted one at a time. As
this is rather inconvenient for a vector-oriented language like R, this
functionality has not been exposed. We instead provide an R6-class
constructor that lets us set all labels and values in one go.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enum_example</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5T_ENUM-class.html">H5T_ENUM</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Label 1"</span>, <span class="st">"Label 2"</span>, <span class="st">"Label 3"</span><span class="op">)</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">5</span>,</span>
<span>    <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For efficiency reasons, an integer datatype is automatically
generated that provides exactly the needed precision in order to store
the values of the enum. Given an enum, variable, we can also find out
what labels and values it has</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enum_example</span><span class="op">$</span><span class="fu">get_labels</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">enum_example</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Label 1" "Label 2" "Label 3"</span></span>
<span><span class="co">## [1] -3  5 10</span></span></code></pre>
<p>In addition, we can also get the datatype back that the enum is based
on</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enum_example</span><span class="op">$</span><span class="fu">get_super</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Class: H5T_INTEGER</span></span>
<span><span class="co">## Datatype: undefined integer</span></span></code></pre>
<div class="section level5">
<h5 id="logical-values">Logical values<a class="anchor" aria-label="anchor" href="#logical-values"></a>
</h5>
<p>A logical variable is a special case of an enum. It is internally
based on a 1-byte unsigned integer that has a precision of 1-bit (so an
n-bit filter will only store a single bit). Its internal values are 0
and 1 with labels <em>FALSE</em> and <em>TRUE</em> respectively. As a
class, it is represented as an H5T_ENUM</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">logical_example</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5T_LOGICAL-class.html">H5T_LOGICAL</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>include_NA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## we could also use h5types$H5T_LOGICAL or h5types$H5T_LOGICAL_NA</span></span>
<span><span class="va">logical_example</span><span class="op">$</span><span class="fu">get_labels</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">logical_example</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "FALSE" "TRUE"  "NA"   </span></span>
<span><span class="co">## [1] 0 1 2</span></span></code></pre>
<p>Note that doLogical has precedence over the <em>labels</em>
parameter.</p>
</div>
</div>
<div class="section level4">
<h4 id="compounds-tables">Compounds (Tables)<a class="anchor" aria-label="anchor" href="#compounds-tables"></a>
</h4>
<p>Tables are represented as <em>COMPOUND</em> HDF5 objects, which are
the equivalent of C-struct. As R does not know this datatype natively,
it has to be converted from structs to the list-based construct of R
data-frames. Similar as with ENUMs, we don’t expose the underlying C-API
that builds the compound on element at a time but instead provide
constructors that create it in one go.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpd_example</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5T_COMPOUND-class.html">H5T_COMPOUND</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Double_col"</span>, <span class="st">"Int_col"</span>, <span class="st">"Logical_col"</span><span class="op">)</span>, dtypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">h5types</span><span class="op">$</span><span class="va">H5T_NATIVE_DOUBLE</span>,</span>
<span>    <span class="va">h5types</span><span class="op">$</span><span class="va">H5T_NATIVE_INT</span>, <span class="va">logical_example</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and similar to enums, we can also get back the column names, the
classes of the datatypes as well as identifiers for the datatypes
itself.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpd_example</span><span class="op">$</span><span class="fu">get_cpd_labels</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Double_col"  "Int_col"     "Logical_col"</span></span></code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpd_example</span><span class="op">$</span><span class="fu">get_cpd_classes</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] H5T_FLOAT   H5T_INTEGER H5T_ENUM   </span></span>
<span><span class="co">## 13 Levels: H5T_NO_CLASS H5T_INTEGER H5T_FLOAT H5T_TIME ... H5T_NCLASSES</span></span>
<span><span class="co">## 13 Values: -1 0 1 2 ... 11</span></span></code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpd_example</span><span class="op">$</span><span class="fu">get_cpd_types</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## Class: H5T_FLOAT</span></span>
<span><span class="co">## Datatype: H5T_IEEE_F64LE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## Class: H5T_INTEGER</span></span>
<span><span class="co">## Datatype: H5T_STD_I32LE</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## Class: H5T_LOGICAL</span></span>
<span><span class="co">## Datatype: H5T_ENUM {</span></span>
<span><span class="co">##       undefined integer;</span></span>
<span><span class="co">##       "FALSE"            0;</span></span>
<span><span class="co">##       "TRUE"             1;</span></span>
<span><span class="co">##       "NA"               2;</span></span>
<span><span class="co">##    }</span></span></code></pre>
<p>A textual description is also available</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">cpd_example</span><span class="op">$</span><span class="fu">to_text</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## H5T_COMPOUND {</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "Double_col" : 0;</span></span>
<span><span class="co">##       H5T_STD_I32LE "Int_col" : 8;</span></span>
<span><span class="co">##       H5T_ENUM {</span></span>
<span><span class="co">##          undefined integer;</span></span>
<span><span class="co">##          "FALSE"            0;</span></span>
<span><span class="co">##          "TRUE"             1;</span></span>
<span><span class="co">##          "NA"               2;</span></span>
<span><span class="co">##       } "Logical_col" : 12;</span></span>
<span><span class="co">##    }</span></span></code></pre>
<div class="section level5">
<h5 id="complex-values">Complex values<a class="anchor" aria-label="anchor" href="#complex-values"></a>
</h5>
<p>We also have a way of representing complex variables, these are a
compound object consisting of two double precision floating point
columns. This also matches nicely the fact that internally in R, complex
values are represented as a struct of doubles.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cplx_example</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5T_COMPLEX-class.html">H5T_COMPLEX</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cplx_example</span><span class="op">$</span><span class="fu">get_cpd_labels</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cplx_example</span><span class="op">$</span><span class="fu">get_cpd_classes</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Real"      "Imaginary"</span></span>
<span><span class="co">## [1] H5T_FLOAT H5T_FLOAT</span></span>
<span><span class="co">## 13 Levels: H5T_NO_CLASS H5T_INTEGER H5T_FLOAT H5T_TIME ... H5T_NCLASSES</span></span>
<span><span class="co">## 13 Values: -1 0 1 2 ... 11</span></span></code></pre>
</div>
</div>
<div class="section level4">
<h4 id="arrays">Arrays<a class="anchor" aria-label="anchor" href="#arrays"></a>
</h4>
<p>A special datatype is the <strong>H5T_ARRAY</strong>. As datasets are
itself arrays, they are not needed to represent arrays itself. Rather,
the are useful in cases where one datatype is wrapped inside another, so
mainly if a column of a compound object is supposed to be an array. So
lets create an array and put it into a compound object together with
some other columns</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">array_example</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5T_ARRAY-class.html">H5T_ARRAY</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>, dtype_base <span class="op">=</span> <span class="va">h5types</span><span class="op">$</span><span class="va">H5T_NATIVE_INT</span><span class="op">)</span></span>
<span><span class="va">cpd_several</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5T_COMPOUND-class.html">H5T_COMPOUND</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"STRING_fixed"</span>, <span class="st">"Double"</span>, <span class="st">"Complex"</span>, <span class="st">"Array"</span><span class="op">)</span>,</span>
<span>    dtypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">str_fixed_len</span>, <span class="va">h5types</span><span class="op">$</span><span class="va">H5T_NATIVE_DOUBLE</span>, <span class="va">cplx_example</span>, <span class="va">array_example</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">cpd_several</span><span class="op">$</span><span class="fu">to_text</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## H5T_COMPOUND {</span></span>
<span><span class="co">##       H5T_STRING {</span></span>
<span><span class="co">##          STRSIZE 20;</span></span>
<span><span class="co">##          STRPAD H5T_STR_NULLTERM;</span></span>
<span><span class="co">##          CSET H5T_CSET_ASCII;</span></span>
<span><span class="co">##          CTYPE H5T_C_S1;</span></span>
<span><span class="co">##       } "STRING_fixed" : 0;</span></span>
<span><span class="co">##       H5T_IEEE_F64LE "Double" : 20;</span></span>
<span><span class="co">##       H5T_COMPOUND {</span></span>
<span><span class="co">##             H5T_IEEE_F64LE "Real" : 0;</span></span>
<span><span class="co">##             H5T_IEEE_F64LE "Imaginary" : 8;</span></span>
<span><span class="co">##          } "Complex" : 28;</span></span>
<span><span class="co">##       H5T_ARRAY {</span></span>
<span><span class="co">##          [4][3] H5T_STD_I32LE</span></span>
<span><span class="co">##       } "Array" : 44;</span></span>
<span><span class="co">##    }</span></span></code></pre>
<p>And to see what this would look like as an R object</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj_empty</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_empty.html">create_empty</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">cpd_several</span><span class="op">)</span></span>
<span><span class="va">obj_empty</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in format.data.frame(if (omit) x[seq_len(n0), , drop = FALSE] else x, :</span></span>
<span><span class="co">## corrupt data frame: columns will be truncated or padded with NAs</span></span></code></pre>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj_empty</span><span class="op">$</span><span class="va">Array</span></span></code></pre></div>
<pre><code><span><span class="co">##   STRING_fixed Double Complex Array</span></span>
<span><span class="co">## 1                   0    0+0i     0</span></span>
<span><span class="co">##  [1] 0 0 0 0 0 0 0 0 0 0 0 0</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="variable-length-data-types">Variable length data types<a class="anchor" aria-label="anchor" href="#variable-length-data-types"></a>
</h4>
<p>And last, there are also variable length datatypes - corresponding to
a list in R where each item of the list has the same datatype (general R
list, where each item can have a different type cannot be represented in
HDF5).</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vlen_example</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/H5T_VLEN-class.html">H5T_VLEN</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>dtype_base <span class="op">=</span> <span class="va">cpd_several</span><span class="op">)</span></span></code></pre></div>
<p>This would represent a list where each item is a table with an
arbitrary number of rows.</p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="implementation-details">Implementation details<a class="anchor" aria-label="anchor" href="#implementation-details"></a>
</h2>
<p>In this section some of the details will be discussed that are likely
only interesting for the technically inclined or someone who would want
to extend the package itself.</p>
<div class="section level3">
<h3 id="closing-of-unused-ids-and-garbage-collection">Closing of unused ids and garbage collection<a class="anchor" aria-label="anchor" href="#closing-of-unused-ids-and-garbage-collection"></a>
</h3>
<p>In this package, the C-API of HDF5 is being used. For the C-API, it
is usually the programmer’s responsibility to close manually an HDF5-ID
that is being used by calling the appropriate “close” function. If
programs are not written very diligently, this can easily lead to
memory-leaks.</p>
<p>As users of R are used to objects being automatically
garbage-collected, such a behavior could pose a significant problem in
R. In order to avoid any issues, the closing of HDF5-IDs is therefore
done automatically using the R garbage collection mechanism.</p>
<p>For every id that is created in the C-code and passed back to R, an
R6-class object is created that is non-cloneable. During creating, the
finalizer (see reg.finalizer) is set so that during garbage collection
of the R6-class object or when shutting down R, the corresponding HDF5
resources are being released.</p>
<p>In addition to this, all HDF5-IDs that are currently in use are being
tracked as well (in the obj_tracker environment; not exported). The
reason for this separate tracking is so that on demand, all objects that
are currently still open in a file can be closed. The special challenge
here is on the one-hand to track every R6 object that is in use in R,
and at the same time not interfere with the normal operation of the R
garbage collection mechanism. To this end, we cannot just save the
environment itself in the obj_tracker (note that in R, an
environment-object is always a pointer to the environment, not the whole
environment itself). If we stored a pointer to the environment itself,
the R garbage collector would never delete the environment as formally
it would still be in use (in the obj_tracker). In order to prevent that,
the following mechanism was implemented:</p>
<ul>
<li>Every HDF5-ID that is in use is wrapped inside an environment.</li>
<li>A pointer to that environment is stored inside the R6-class as well
as the obj_tracker</li>
<li>This way, the R6-class is not referenced directly by the
obj_tracker, however it is possible, by accessing the environment the ID
is</li>
<li>wrapped in through the object tracker to set the ID that is stored
inside it to NA - thereby invalidating it.</li>
<li>As the R6-class is only storing a pointer to the environment, for it
the ID will now also appear as NA.</li>
</ul>
<p>As mentioned, this was mainly implemented to allow for the closing of
all IDs that are still open inside a file and to invalidate all existing
R6-classes as well.</p>
<div class="section level4">
<h4 id="opening-and-closing-of-files">Opening and closing of files<a class="anchor" aria-label="anchor" href="#opening-and-closing-of-files"></a>
</h4>
<p>In this context, let us quickly also discuss the special way HDF5
handles files. In HDF5, in principle a file can always only be opened
once. This can lead to problems as users in R are used to being able to
open files as often as they like. Furthermore, it is possible in HDF5 to
close the ID of a file without closing all objects in the file. Then,
however, the file actually stays open until the last ID pointing into
the file is closed and it cannot be opened again without it.</p>
<p>Therefore, as already explained above (and as recommended by the HDF5
manual), do not discard or close files that still have open objects in
them. It is preferable to keep the HDF5-file-id pointer around and close
it when it is no longer needed (and all objects inside the file) using
the <strong>close_all</strong> method.</p>
</div>
</div>
<div class="section level3">
<h3 id="conversion-of-datatypes">Conversion of datatypes<a class="anchor" aria-label="anchor" href="#conversion-of-datatypes"></a>
</h3>
<p>A special feature of this package is the far-reaching and flexible
implementation of data-conversion routines between R and HDF5. Routines
have been implemented for all datatypes, string, data-frames, arrays and
variable length (HDF5-VLEN) objects. Some are relatively
straightforward, others are more complicated. Here, numeric datatypes
can be tricky due to the limited ability of R to represent certain
datatypes, specifically long doubles or 64bit-integers.</p>
<div class="section level4">
<h4 id="numeric-datatypes">Numeric datatypes<a class="anchor" aria-label="anchor" href="#numeric-datatypes"></a>
</h4>
<p>For numeric datatypes, the situation is in certain circumstances a
bit tricky. In general, R numerical objects are either represented as
64-bit floating point values (doubles) or 32-but integers. R switches
relatively transparently between these types as needed (for
computations, integers are converted to doubles and conversely, array
positions can be addressed by doubles). The main issue when working with
HDF5 occurs as R doesn’t have either a 64bit signed or unsigned integer
datatype (and also not a long double). In order to work around this
issue, the following conventions are being used</p>
<ul>
<li>The package uses the <strong>bit64</strong> package to provide
support for 64-bit integers. These are used extensively (e.g. for ids)
and also for numeric integer data types.</li>
<li>32 bit and 64 bit floats from HDF5 are always returned as 64 bit
floats in R. Writing 32 bit floats from R, may always incur loss of
precision of the underlying 64 bit double that is used to represent it
in R.</li>
<li>For integer data types, any HDF5 integer type that can accurately be
represented as a 32-bit signed integer will be returned to R as a
regular integer (can be changed using flags). Any HDF5 64-bit integer
can be returned as a signed 64-bit integer - with the option of
returning it as a 32 bit integer or double if it can be done without
loss of precision. For unsigned 64-bit integers, they will be returned
as floats, incurring loss of precision but avoiding truncation.</li>
</ul>
<p>An overview of how the data conversion is being done can be seen
here:</p>
<div class="figure">
<img src="DatatypeConversionDiagram.png" alt=""><p class="caption">Schematic of dataype conversion</p>
</div>
<p>The underlying principle is that any internal conversion between R
types is done by R (with the resulting handling of NA’s and overflows),
whereas any conversion between R-types and Non-R-types is done by the
HDF5 library (usually meaning that on overflow, truncation occurs).</p>
</div>
<div class="section level4">
<h4 id="strings-1">Strings<a class="anchor" aria-label="anchor" href="#strings-1"></a>
</h4>
<p>In HDF5, strings can either be variable length or fixed length
strings. In R, they are always variable length. Therefore, strings from
R to HDF5 that are written into fixed-length fields will be truncated.
Conversely, strings from HDF5 that are fixed length to R will only be
returned up the the NULL character that ends strings in C.</p>
</div>
<div class="section level4">
<h4 id="data-framescompounds">Data-frames/Compounds<a class="anchor" aria-label="anchor" href="#data-framescompounds"></a>
</h4>
<p>The situation is a bit more tricky for table-like objects. In R,
these are data-frames, which internally are a list of vectors. In HDF5,
a table is a Compound object, that is equivalent to C-struct -
i.e. every row is represented together whereas in R every column is
represented together. Each of these approaches has certain advantages,
but the challenge here is to translate between them.</p>
<p>This is done in the straightforward manner. When converting from R to
HDF5, the columns of the tables are copied into the struct whereas in
the reverse direction, every struct is decomposed into the corresponding
columns.</p>
<p>The Data-frame &lt;-&gt; Compound conversion is also extensively used
for HDF5-API functions that return structs as result (and therefore
return data-frames).</p>
</div>
<div class="section level4">
<h4 id="arrays-data-types">Arrays data-types<a class="anchor" aria-label="anchor" href="#arrays-data-types"></a>
</h4>
<p>In HDF5, datasets itself can have arbitrary dimensions. In addition
to that, there are also array-datatypes that allow for the inclusion for
arrays e.g. inside a compound object. Translation to and from arrays is
relatively straightforward and only involves setting the correct
<em>dim</em> attribute in R.</p>
<p>In addition to that, however, there is small complication. In R, the
first dimension is the fastest changing dimension. In HDF5 (same as in
C), the last dimension is however the fastest changing one. For
datasets, we work around this problem by always reversing the dimensions
that are passed between R and HDF5 and therefore making the distinction
transparent. For arrays, this is however a bit trickier. For example let
us assume that we have a dataset that is a one-dimensional vector of
length 10, each element of which is an array-datatype of length 4,
resulting in a 10 x 4 dataset. However, it is now not quite clear how
this should be represented in R. If we follow the notion, that the
fastest changing dimension in R is the first one, the result would be a
dataset with 4 rows and 10 columns, i.e. 10 x 4.</p>
<p>This does feel rather unintuitive, forcing a user to specify the
second dimension to get all items of the array. Therefore, we have
implemented it so that a 10 x 4 dataset is returned, with each row
corresponding to the array-datatype. In order to achieve this we have to
deviate from the ordering principle in HDF5. Where in HDF5, the elements
of the first internal array are in position 1, 2, 3 and 4 (or 0 to 3
when you start counting at 0), in R they are now in position 1, 11, 21,
and 31. In order to do this, we first internally read the HDF5 array
into an R-array of shape 4 x 10 and then transpose the result.</p>
</div>
<div class="section level4">
<h4 id="variable-length-data-types-1">Variable-length data types<a class="anchor" aria-label="anchor" href="#variable-length-data-types-1"></a>
</h4>
<p>In HDF5, there are also variable-length data types. Essentially, this
corresponds to an R list-like object, with the additional restriction
that every item of the list has to be of the same datatype. This is also
how it is implemented. R list where all items are vectors (of arbitrary
length) of the same type can be converted to HDF5-VLEN objects and vice
versa.</p>
</div>
<div class="section level4">
<h4 id="reference-objects">Reference objects<a class="anchor" aria-label="anchor" href="#reference-objects"></a>
</h4>
<p>As of the writing of this vignette, these have not yet been
implemented.</p>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="future-directions">Future directions<a class="anchor" aria-label="anchor" href="#future-directions"></a>
</h2>
<ul>
<li>Custom table class</li>
<li>API for dplyr</li>
<li>Ability to store and retrieve missing values for any datatype</li>
<li>In-memory datasets</li>
<li>HDF5 references classes</li>
<li>Improved support in R for different datatypes (mainly uint64)</li>
<li>Static HTML manual pages</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Holger Hoefling, Mario Annau.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
